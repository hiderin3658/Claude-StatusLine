# AI 共通コーディングルール

> 全プロジェクトで統一した開発方針を維持するための共通ルールです。

---

## 1. 回答言語・Git操作に関する基本ルール（重要）

- **必ず日本語で回答すること。** コード内のコメントやドキュメントも日本語で記述する。
- **Git操作のルール（Claude Code使用時）**:
  - `git commit`（ローカル操作）: 自動実行許可 ✅
  - `git push`（リモート操作）: 必ずユーザーに確認が必要 ⚠️

---

## 2. 自動実行ポリシー（Claude Code 専用）

### 2.1 基本原則

- **デフォルト動作**: ユーザーが「確認してください」と明示しない限り、確認なしで自動実行
- **質問は最小限**: 技術的に判断できる内容は質問せず自動で進める
- **エラーは自動修正**: ビルドエラー、リンタエラー、レビュー指摘は自動で修正して再実行

### 2.2 破壊的コマンドの拒否（要約）

以下のカテゴリのコマンドは**絶対に実行禁止**:
- システムディレクトリの削除（`/`, `/etc`, `/usr`, `~` 等）
- sudo による権限変更・サービス操作（削除以外）
- ディスク・パーティション操作（`dd`, `mkfs`, `diskutil erase` 等）
- main/master への force push
- WHERE句なしの DELETE/UPDATE

> 詳細リストは `~/.claude/references/DESTRUCTIVE_COMMANDS_BLOCKLIST.md` を参照

### 2.3 操作の分類

| 分類 | 操作例 | アクション |
|-----|-------|-----------|
| **自動実行可** | Read/Edit/Write、git add/commit（featureブランチ）、ビルド/テスト/リンタ、ローカルサーバー起動 | 確認なしで実行 |
| **確認が必要** | git push、**main/masterへのcommit**、パッケージ追加、デプロイ、ディレクトリ削除、DB操作 | 実行前にユーザー確認 |
| **実行禁止** | システム破壊コマンド、main/master force push | 絶対に実行しない |

### 2.4 エラー時のリトライ

- **自動リトライ可**: ビルドエラー、リンタエラー、テスト失敗、タイポ修正
- **確認が必要**: 外部API失敗、認証エラー、3回以上連続で同じエラー

---

## 3. 禁止事項・注意事項（共通）

- ライブラリやフレームワークを**勝手に追加・変更しない**（提案時は理由と代替案も示す）
- セキュリティ上問題になるコード（ハードコーディングされた秘密情報など）は書かない
- 破壊的操作は提案する場合も必ず注意書きを添える

---

## 4. ソースコードレビュー自動実行（Claude Code 専用）

### 4.1 自動実行ポリシー

| 設定項目 | 値 |
|---------|-----|
| **自動修正範囲** | Critical, High, Medium, Low（Info以外すべて） |
| **完了条件** | すべての指摘がゼロになるまで繰り返す |

### 4.2 レビュー重大度

| 重大度 | アクション |
|--------|-----------|
| Critical / High / Medium / Low | **自動修正** → 再レビュー |
| Info | 修正しない（参考情報として報告のみ） |

### 4.3 レビュー観点

- **セキュリティ**: SQLインジェクション、XSS、認証バイパス、機密情報漏洩
- **エラーハンドリング**: 例外の握りつぶし、リトライロジック
- **パフォーマンス**: N+1問題、メモリリーク、不要な同期処理
- **コード品質**: DRY原則、単一責任、命名規則、型ヒント

---

## 5. Claude Code 専用機能

### 5.1 ツール使用の優先順位

| 操作 | 優先 | 避ける |
|-----|------|-------|
| 読取 | Read ツール | cat, head, tail |
| 編集 | Edit ツール | sed, awk |
| 作成 | Write ツール | echo >, cat <<EOF |
| 検索 | Glob/Grep ツール | find, grep |

### 5.2 作業管理

- **TodoWrite**: 3つ以上のステップ、複数ファイル変更、10分以上の作業で使用
- **Task/Agent**: 大規模コードベース探索、複雑な調査で使用
- **EnterPlanMode**: 3ファイル以上の変更、アーキテクチャ判断が必要な場合

### 5.3 コンテキスト効率化

**読み込み効率化**:
- Grep/Globで該当箇所を特定してから、offset/limitで必要部分のみ読む
- 独立した検索・読み込みは並列実行

**出力の最適化**:
- 回答は簡潔に、冗長な説明を避ける
- コード例は必要最小限、既出情報の繰り返しを避ける
- ツール出力が長い場合は要約して報告

**状態管理**:
- TodoWriteで進捗を記録し、コンテキストに依存しない
- 1分以上のビルド/テストは run_in_background

### 5.4 Web検索

**優先順位**: 公式ドキュメント > GitHub Issue > Stack Overflow > 技術ブログ

### 5.5 ステータスラインのデーモン

Claude Code の使用率をステータスラインに表示するためのデーモン。

| 項目 | パス |
|------|------|
| **デーモン** | `~/.claude/ccusage-daemon.mjs` |
| **キャッシュ** | `~/.claude/cache/ccusage-cache.json` |
| **ウィンドウ情報** | `~/.claude/usage-window.json` |

「ステータスラインのデーモン」で本デーモンを指す。

**確認依頼時のチェック項目**:
1. デーモンプロセスの起動確認: `ps aux | grep ccusage-daemon`
2. ウィンドウ開始時間の確認: `~/.claude/usage-window.json` の `windowStart` を表示

---

## 6. 開発全般の共通方針

- 可読性と保守性を優先し、トリッキーな書き方は避ける
- 静的解析・リンタを尊重する
- **既存コードのスタイルに合わせる**ことを優先

---

## 7. コーディングスタイル共通ルール

### 7.1 命名規則

- 変数・関数は意味が分かる名前（`data`, `info` 等の汎用名は避ける）
- boolean は `is/has/should/can` プレフィックス
- 定数は大文字スネークケース、クラス名は PascalCase

### 7.2 コメント

- **日本語**で記述（OSS/外部公開APIは英語可）
- 不要なコメントは書かない
- TODOには理由を書く

### 7.3 エラーハンドリング

- 例外は**握りつぶさない**
- 予期せぬ例外はログに出しスタックトレースを残す
- ユーザー向けメッセージと内部ログは分ける

### 7.4 ログ

- **必須ログ**: API呼び出し、認証、DB操作、エラー
- **レベル**: ERROR（エラー）、WARNING（警告）、INFO（重要処理）、DEBUG（開発時のみ）
- デバッグログはコミット前に削除

### 7.5 テスト

- ビジネスロジック追加時はテストもセットで提案
- テスト名は失敗時に原因が分かるように具体的に

---

## 8. AI 共通開発支援ルール

### 8.1 Git ブランチ運用

- `feature/*`: 新機能、`fix/*`: バグ修正、`refactor/*`: リファクタリング、`docs/*`: ドキュメント

### 8.2 コミットメッセージ

> テンプレートは `~/.claude/templates/COMMIT_MESSAGE_TEMPLATE.md` を参照

**基本形式**: `<type>(<scope>): <概要>`
- type: feat, fix, docs, style, refactor, perf, test, chore, ci
- 概要は50文字以内（日本語は25文字程度）

### 8.3 プルリクエスト

> テンプレートは `~/.claude/templates/PR_TEMPLATE.md` を参照

### 8.4 ドキュメント

- **自動生成を避ける**: README.md, CHANGELOG.md（明示的依頼時のみ）
- **積極的に作成**: 設計書、API仕様書、実装サマリー

---

## 9. プロジェクトごとのルールとの関係

- 各プロジェクトの `CLAUDE.md` で例外や追加ルールを定義
- 共通ルールとプロジェクトルールが衝突する場合は**プロジェクト側を優先**
- ただし、重大なセキュリティ・品質ルールは共通側を優先

---

## 10. 更新ポリシー

- 定期的に見直し（半年に一度）
- 大きな方針変更時はプロジェクト側テンプレも確認

### 更新履歴

- 2026-01-09: スリム化実施（759行 → 約200行）
  - 破壊的コマンドリストを外部ファイル化
  - PRテンプレート、コミットメッセージテンプレートを外部ファイル化
  - メタ情報セクションを削除
  - コード例を簡略化
  - コンテキスト効率化セクションを拡充
