# AI 共通コーディングルール

> このファイルは AI アシスタント（ChatGPT / Claude / その他）に共有する共通開発ルールです。
> 全プロジェクトで統一した開発方針を維持するために使用します。

---

## 1. このメモリの目的

- どのプロジェクトでも共通して守ってほしい開発ルールを AI に伝える  
- AI コーディング時の「ブレ」を減らし、レビューの手間を減らす  
- 個々のリポジトリ固有の事情は **プロジェクトごとのテンプレ側（例: CLAUDE.md, RULES.md）** に記載する

---

## 2. 対象とする AI アシスタント

- ChatGPT（GPT 系）
- Claude（Claude Code を含む）
- その他、プロンプトベースでコードを生成・修正できるツール

※ ここに書かれている内容は、特定ツール専用ではなく「共通方針」です。

---

## 3. 回答言語・コミットに関する基本ルール（重要）

- **必ず日本語で回答すること。**
  - コード内のコメントやドキュメントも、特に指定がない限り日本語で記述する。
- **こちらが明示的に指示するまで、コミット（git commit 相当の操作）は行わないこと。**
  - 提案としてコミットメッセージの例を出すのは構わないが、実際のコミット操作はユーザーが行う前提とする。

> AI への指示例：  
> 「回答・説明・コメントは必ず日本語で行い、私から『コミットしてよい』と指示があるまでは git commit に相当する操作は行わないでください。」

---

## 4. 開発全般の共通方針

- 可読性と保守性を優先し、「短さ」だけを目的としたトリッキーな書き方は避ける
- 原則として **静的解析・リンタを尊重する**
- バグの温床になりやすい書き方（グローバル状態の乱用、マジックナンバー、過剰なネストなど）は避ける
- AI は **既存コードのスタイルに合わせる** ことを優先する

---

## 5. コーディングスタイル共通ルール

### 5.1 命名規則（言語共通）

- 変数・関数は意味が分かる名前にする（`data`, `info` などの汎用名は避ける）
- boolean は `is/has/should/can` などのプレフィックスを付ける（例: `isActive`, `hasError`）
- 定数は大文字スネークケース、もしくは各言語の慣習に従う（例: `MAX_RETRY_COUNT`）
- クラス名 / コンポーネント名は PascalCase

> AI への指示例：  
> 「変数名・関数名は、役割が分かる英語で命名し、boolean は is/has/should などのプレフィックスを付けてください。」

---

### 5.2 コメントと言語

- コメント・ドキュメントは **原則として日本語** で記述する
- 外部公開 API や OSS では必要に応じて英語を使用してもよい
- 不要なコメント（コードから自明な説明）は書きすぎない
- TODO コメントには理由も書く

```ts
// ❌ 悪い例
// TODO: 修正
function calc() {}

// ✅ 良い例
// TODO: パフォーマンス改善のため、バッチ処理に変更する
function calculateMonthlyReport() {}
```

---

### 5.3 エラーハンドリング

- 例外・エラーは **握りつぶさない**
- 可能な限り、呼び出し元で扱いやすい形に変換してから投げ直す
- 予期せぬ例外はログに出し、スタックトレースの情報を残す
- ユーザー向けメッセージと内部ログメッセージは分ける

> AI への指示例：  
> 「例外は握りつぶさず、少なくともログ出力するか呼び出し元に伝播させてください。」

---

### 5.4 ログの方針（共通）

#### 運用ログ（恒久的）
- **必須のログポイント**：
  - API呼び出しの成功/失敗（外部サービス連携）
  - 認証・認可の成功/失敗
  - データベース操作（作成/更新/削除）
  - 重要な業務処理の開始/完了
  - エラー発生時の詳細情報
  - パフォーマンス情報（処理時間が長い操作）

- **ログレベルの使い分け**：
  - `ERROR`: エラーとスタックトレース
  - `WARNING`: 警告（リトライ、フォールバック等）
  - `INFO`: 重要な正常処理（ユーザーログイン、注文完了等）
  - `DEBUG`: 開発時のみ有効（本番では出力しない）

#### デバッグログ（一時的）
- **エラー調査時の追加ルール**：
  - エラー発生時は、前後の処理にデバッグログを追加
  - 変数の中身、関数の引数/戻り値を出力
  - ループ処理では、反復回数と処理対象を記録
  - **重要**: コミット前に必ずデバッグログを削除

```python
# ✅ 良い例（運用ログ）
logger.info(f"User login successful: user_id={user_id}")
logger.error(f"API call failed: service={service}, error={str(e)}", exc_info=True)

# 🔧 デバッグログの例（コミット前に削除）
logger.debug(f"[DEBUG] Processing item: {item}")  # TODO: Remove before commit
print(f"[DEBUG] Current state: {state}")  # TODO: Remove before commit
```

> AI への指示例：
> 「運用に必要なログは最初から実装し、エラー調査時のデバッグログは明確に[DEBUG]とマークして、
> コミット前に削除することを TODO コメントで明記してください。」

---

### 5.5 テストに関する共通方針

- 新しいビジネスロジックや複雑な処理を追加する場合、**可能な範囲でテストコードもセットで提案する**
- テスト名（テストケース名）は、失敗時に原因が分かるように具体的に書く
- モック／スタブの使いすぎでテストが意味を失わないよう注意する

> AI への指示例：  
> 「ビジネスロジックを追加する場合は、可能な範囲で単体テストの例も提示してください。」

---

## 6. AI への依頼方法に関する共通ルール

AI にコード生成・修正を依頼するときは、次の点を守る：

1. **目的と前提を最初に伝える**
   - 何の機能か／どのユーザーが使うか／ざっくりした仕様
2. **使用する技術スタックは必ず明示する**
   - 例：TypeScript + React 18, Python 3.11 + FastAPI など
3. **リンタ・フォーマッタの方針を伝える**
   - 例：ESLint（Airbnbベース）＋ Prettier、ruff + black など
4. **欲しい出力の形式を指定する**
   - 単一ファイルか、差分か、関数だけなのか、など
5. **最後に自己チェックを求める**
   - 未使用変数・型の不整合・タイポなどのセルフレビュー

> AI へのテンプレ依頼文（例）：  
> 「これから示す共通ルールに従ってコードを書いてください。
> コードの提示後、自分で未使用変数・型の不整合・明らかな誤りがないか簡単に自己チェックし、
> 気になる点があればコメントで指摘してください。」

---

## 7. AI アシスタント共通の開発支援ルール

### 7.1 Git ブランチ運用

**ブランチ作成・切り替え：**
- feature/* : 新機能開発
- fix/* : バグ修正
- refactor/* : リファクタリング
- docs/* : ドキュメント更新

**コミットメッセージテンプレート：**
```
<type>: <概要（50文字以内）>

<詳細説明（任意）>
- 変更の理由
- 実装の詳細
- 影響範囲

<footer（任意）>
Issue #123
Co-authored-by: Name <email>
```

**プルリクエストテンプレート：**
```markdown
## 概要
<!-- このPRで実現したいことを簡潔に記述 -->

## 変更内容
<!-- 主要な変更点を箇条書きで -->
-
-
-

## 変更の種類
<!-- 該当するものにチェック -->
- [ ] 🐛 バグ修正 (Bug fix)
- [ ] ✨ 新機能 (New feature)
- [ ] 🔧 リファクタリング (Refactoring)
- [ ] 📝 ドキュメント (Documentation)
- [ ] 🎨 UI/UX改善 (UI/UX improvement)
- [ ] ⚡ パフォーマンス改善 (Performance)
- [ ] 🔒 セキュリティ (Security)

## 動作確認
<!-- 確認した内容を記述 -->

### テスト実行結果
```bash
# テストコマンドと結果を貼り付け
```

### スクリーンショット（UIの変更がある場合）
<!-- 必要に応じて before/after のスクリーンショット -->

## チェックリスト
- [ ] コードレビューの準備が完了している
- [ ] テストが全て通っている
- [ ] リンタ・フォーマッタでエラーがない
- [ ] ドキュメントを更新した（必要な場合）
- [ ] 破壊的変更がない（ある場合は詳細記載）

## 関連Issue/PR
<!-- 関連するIssueやPRがあればリンク -->
- Issue #
- PR #

## レビュー依頼事項
<!-- レビュアーに特に見てもらいたい点 -->

## その他
<!-- その他の連絡事項 -->

---
🤖 Generated with [Claude Code](https://claude.com/claude-code)
```

> AI への指示例：
> 「プルリクエストを作成する際は、上記テンプレートを使用して
> 変更内容、テスト結果、チェックリストを明確に記載してください。」

### 7.2 ドキュメント作成方針

**自動生成を避けるべきドキュメント：**
- README.md（プロジェクトの顔となるため、ユーザーが明示的に依頼した場合のみ）
- CHANGELOG.md（リリース管理に関わるため）

**積極的に作成すべきドキュメント：**
- 設計書（DESIGN.md等）
- API仕様書（OpenAPI/Swagger形式推奨）
- 実装サマリー（IMPLEMENTATION_SUMMARY.md等）

### 7.3 コード品質チェック

**実装完了時の基本確認：**
- 未使用の変数・インポートの削除
- 適切なエラーハンドリング
- コメントの追加（日本語）

### 7.4 ファイル操作の注意

**破壊的操作の前に必ず確認：**
- 削除操作（`rm -rf` 等）
- 上書き保存（既存ファイルの変更）
- データベース操作
- 本番環境への影響

---

## 8. Claude Code 専用の機能と注意事項

> **注意**: このセクションは Claude Code を使用する場合のみ適用されます。
> ChatGPT、GitHub Copilot、その他の AI アシスタントでは適用されません。

### 8.1 Claude Code 専用ツールの使用（Claude Code のみ）

**ファイル操作では専用ツールを優先使用する：**
- **読取**: Read ツール > `cat`, `head`, `tail` コマンド
- **編集**: Edit ツール > `sed`, `awk` コマンド
- **作成**: Write ツール > `echo >`, `cat <<EOF` によるファイル作成
- **検索**: Glob/Grep ツール > `find`, `grep` コマンド

> 理由：Claude Code の専用ツールは安全性が高く、操作の取り消しや履歴管理が容易

### 8.2 Bash コマンド実行時の注意（Claude Code のみ）

**以下の場合は必ず事前確認を行う：**
- 破壊的操作（`rm -rf`, `git reset --hard`, データベース削除等）
- 本番環境への影響がある操作
- 課金が発生する可能性のある操作
- システム設定の変更

**Bash を使うべき場合（例外）：**
- git 操作（commit, push, pull, branch管理）
- パッケージ管理（npm, pip, yarn等）
- ビルド・テストコマンド
- 環境構築・サーバー起動

### 8.3 TodoWrite による作業管理（Claude Code のみ）

**必ず TodoWrite を使用すべき場面：**
- 3つ以上のステップがある作業
- 複数ファイルにまたがる変更
- 推定10分以上かかる作業
- ユーザーから複数のタスクを依頼された場合

**TodoWrite の基本ルール：**
- 完了したタスクは即座に `completed` に更新
- 同時に `in_progress` にできるのは1つのタスクのみ
- 作業開始前に全体計画を TodoWrite で可視化

### 8.4 Task ツールの活用（Claude Code のみ）

**Agent/Task ツールを使用すべき場面：**
- 大規模なコードベースの探索
- 複雑な検索・調査作業
- 複数ラウンドの試行錯誤が必要な作業

---

## 9. 禁止事項・注意事項（共通）

- ライブラリやフレームワークを **勝手に追加・変更しない**
  - 新しい依存を提案する場合は、理由と代替案も示す
- セキュリティ上問題になりそうなコード（ハードコーディングされた秘密情報など）は書かない
- 実行コマンド（`rm -rf` 系）や破壊的操作は、提案する場合も必ず注意書きを添える
- git 操作に関しては、**ユーザーの指示があるまで commit / push 相当の操作は行わない**（提案レベルにとどめる）

---

## 10. プロジェクトごとのルールとの関係

- このファイルは「全プロジェクト共通」の基本方針を定めるもの
- 各リポジトリ／プロジェクトでの **例外や追加ルール** は、プロジェクト専用の Markdown（例: `CLAUDE.md`, `RULES.md`）で上書きする
- 共通ルールとプロジェクトルールが衝突する場合は、
  - 原則として「プロジェクト側のルール」を優先する
  - ただし、重大なセキュリティ・品質ルールは共通側を優先する（※組織の方針に合わせて編集）

---

## 11. 更新ポリシー

- この共通メモリは、**定期的に見直し**を行う（例：半年に一度）
- 大きな方針変更がある場合は、プロジェクト側テンプレも同時に見直す
- 更新履歴や改訂日を下に追記して管理する

---

### 更新履歴

- 2025-01-01: 初版作成
- 2025-02-XX: 回答言語・コミットに関する共通ルールを追加
- 2025-12-09: セクション構成を変更
  - セクション7: AI アシスタント共通ルール（全AI共通）
  - セクション8: Claude Code 専用機能（Claude Codeのみ）
- 2025-12-10: ログ方針とプルリクエストテンプレートを追加
  - セクション5.4: 運用ログとデバッグログの詳細化
  - セクション7.1: プルリクエストテンプレートを追加
